# Code Generation and Auto-Generated Keywords

Many keyword classes in `src/ansys/dyna/core/keywords/keyword_classes/auto/` are auto-generated by Jinja templates. Avoid modifying these files directly.

## Codegen System: High-Level Design

The codegen system is responsible for generating Python classes and import machinery for LS-DYNA keywords. Its architecture consists of:

- **Specification Loading**: Reads keyword/card/field definitions from JSON manifest files (`kwd.json`, `manifest.json`, `additional-cards.json`).
- **Handler Pipeline**: Applies a series of handlers to process and transform the loaded specifications. Each handler encapsulates a specific transformation or enrichment step.
- **Template Rendering**: Uses Jinja templates to generate Python code for keyword classes, importers, and type mappings. Context for templates is built from processed specifications.
- **Output Management**: Writes generated files to the appropriate locations, typically under `src/ansys/dyna/core/keywords/keyword_classes/auto/`.

### Typical Flow

1. **Run `generate.py`**: Entry point for code generation. CLI options allow for cleaning (`-C`) and generation.
2. **Load Specs**: Manifest and keyword definitions are loaded and validated.
3. **Apply Handlers**: Each handler processes the data, adding relationships, defaults, or other logic.
4. **Render Templates**: Jinja templates are rendered using the processed context.
5. **Write Output**: Generated files are written to disk.

### Extending or Customizing

- For changes affecting all keywords, update the codegen templates or handler logic.
- For keyword-specific customizations, create manual subclasses as described below.

See `codegen/todo.md` for architectural improvement recommendations.

## When Auto-Generated Files Change

If you need to extend or customize a keyword class, follow these steps:

1. **Check if modification is necessary**: Review whether your change should be in the codegen system itself (preferred) or in a manual override.
2. **For minor extensions** (properties, helper methods): Create a manual subclass.
3. **For systemic changes** (affecting all keywords): Update the codegen templates.

## Creating a Manual Subclass

1. Create a file under `keyword_classes/manual/` with the same name as the auto-generated class.
2. Import and subclass the auto-generated class:
   ```python
   from ansys.dyna.core.keywords.keyword_classes.auto.define_table import DefineTable as _AutoDefineTable
   
   class DefineTable(_AutoDefineTable):
       # Add custom properties, methods, etc.
   ```
3. Export it from `manual_keywords.py`:
   ```python
   from .manual.define_table import DefineTable  # noqa: F401
   ```
4. The manual class will override the auto-generated class when `keyword_classes` is imported.

## Why This Approach?

- **Preserves codegen**: Regenerating auto classes won't overwrite your customizations.
- **PR-friendly**: Codegen checks verify that auto files match the templates; manual subclasses don't interfere.
- **Maintainable**: Changes are isolated and clear.
