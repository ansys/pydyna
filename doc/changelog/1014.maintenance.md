Add codegen test cases and improve coverage
