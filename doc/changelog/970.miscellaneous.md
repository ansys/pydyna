Refactor: Rework codegen 2
