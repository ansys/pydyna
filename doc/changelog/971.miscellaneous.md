Refactor: Rework codegen 3
