Refactor: Rework codegen 6
